---
date: '2009-01-05T19:29:00+00:00'
title: Add a Context Processor for your Django app using Sites
draft: false
tags:
- Programming
- Python
- django
slug: add-a-context-processor-for-your-django-app-using-sites
description: I've recently refact...
markup: html
url: /blog/add-a-context-processor-for-your-django-app-using-sites/
aliases:
- /blog/2009/01/05/add-a-context-processor-for-your-django-app-using-sites/

---

I've recently refactored a significant number of my Django Apps so that they include the "<a href="http://docs.djangoproject.com/en/dev/ref/contrib/sites/#ref-contrib-sites">sites</a>" framework.  Essentially, this allows me to use the same code (and database) for multiple sites. <br /><br />For Example, if I was was building a <abbr title="Content Management System">CMS</abbr> (and I am!),  I might have a model that defines a "page":<br /><br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.db</span> <span style="color: #007020; font-weight: bold">import</span> models<br /><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.contrib.auth.models</span> <span style="color: #007020; font-weight: bold">import</span> User<br /><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.contrib.sites.models</span> <span style="color: #007020; font-weight: bold">import</span> Site<br /><br /><span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">Page</span>(models<span style="color: #666666">.</span>Model):<br />    title <span style="color: #666666">=</span> models<span style="color: #666666">.</span><span style="color: #007020">CharField</span>(<span style="color: #4070a0">&#39;title&#39;</span>, max_length<span style="color: #666666">=</span><span style="color: #40a070">255</span>)<br />    content <span style="color: #666666">=</span> models<span style="color: #666666">.</span><span style="color: #007020">TextField</span>()<br />    author <span style="color: #666666">=</span> models<span style="color: #666666">.</span><span style="color: #007020">ForeignKey</span>(User)<br />    sites <span style="color: #666666">=</span> models<span style="color: #666666">.</span><span style="color: #007020">ManyToManyField</span>(Site, <br />                  help_text<span style="color: #666666">=</span><span style="color: #4070a0">&quot;This page will be displayed on the selected Sites&quot;</span>)</pre></div><br /><br />Note that the Page class has a <a href="http://docs.djangoproject.com/en/dev/ref/models/fields/#manytomanyfield">ManyToManyField</a> relation ship to a Django Site, which allows a page to be associated with one or more Sites.  The neat thing about this, is that when I publish content on a Page, it can be published to one or more sites!<br /><br />While working with this, I discovered I often wanted to write template code that <em>knew</em> which which Site it was associated.  For example, I might have a base template containing a block inside html head elements so templates that inherit it can include external javascript or CSS files.  For example, <em>base.html</em> might include the following:<br /><div class="highlight" ><pre><span style="color: #062873; font-weight: bold">&lt;html&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;head&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;title&gt;</span><br />    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">block</span> <span style="color: #bb60d5">title</span> <span style="color: #007020">%}{%</span> <span style="color: #007020; font-weight: bold">endblock</span> <span style="color: #007020">%}</span><br /><span style="color: #062873; font-weight: bold">&lt;/title&gt;</span><br />    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">block</span> <span style="color: #bb60d5">head</span> <span style="color: #007020">%}</span> <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">endblock</span> <span style="color: #007020">%}</span><br /><span style="color: #062873; font-weight: bold">&lt;/head&gt;</span></pre></div><br /><br />Then, in any template that inherits from base.html, I could do something like the following:<br /><div class="highlight" ><pre><span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">extends</span> <span style="color: #4070a0">&quot;base.html&quot;</span> <span style="color: #007020">%}</span><br /><span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">block</span> <span style="color: #bb60d5">head</span> <span style="color: #007020">%}</span><br />    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">ifequal</span> <span style="color: #bb60d5">current_site.domain</span> <span style="color: #4070a0">&quot;www.whatever.com&quot;</span> <span style="color: #007020">%}</span><br />        <span style="color: #062873; font-weight: bold">&lt;link</span> <span style="color: #4070a0">rel=&quot;stylesheet&quot;</span> <span style="color: #4070a0">type=&quot;text/css&quot;</span> <span style="color: #4070a0">href=&quot;/media/whatever.css&quot;</span> <span style="color: #062873; font-weight: bold">/&gt;</span><br />    <span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">endifequal</span> <span style="color: #007020">%}</span><br /><span style="color: #007020">{%</span> <span style="color: #007020; font-weight: bold">endblock</span> <span style="color: #007020">%}</span></pre></div><br /><br />There trick here, though, is "How is my template going to know what site is being requested?"<br /><br />I <em>could</em> put something like the following in <b>every</b> view I write...<br /><div class="highlight" ><pre>current_site <span style="color: #666666">=</span> Site<span style="color: #666666">.</span>objects<span style="color: #666666">.</span>get_current()</pre></div>BUT, that's a lot of extra stuff to type.  Especially if you have a lot of views.<br /><br />The clever thing to do, would be to write code so that a Site object containing the currently requested site is automatically added to the current <a href="http://docs.djangoproject.com/en/dev/ref/templates/api/#basics">Context</a>.  We can do that by writing our own <b>Context Processor</b>!<br /><br />And that's just what I did!  The following code is fairly simple.  It just retrieves the current Site from given request object (using Site.objects.get_current()), then returns a dictionary mapping the current site to the variable name <b>current_site</b>. <br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.conf</span> <span style="color: #007020; font-weight: bold">import</span> settings<br /><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.contrib.sites.models</span> <span style="color: #007020; font-weight: bold">import</span> Site<br /><br /><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">current_site</span>(request):<br /><span style="color: #4070a0; font-style: italic">&#39;&#39;&#39;</span><br /><span style="color: #4070a0; font-style: italic">A context processor to add the &quot;current site&quot; to the current Context</span><br /><span style="color: #4070a0; font-style: italic">&#39;&#39;&#39;</span><br />    <span style="color: #007020; font-weight: bold">try</span>:<br />        current_site <span style="color: #666666">=</span> Site<span style="color: #666666">.</span>objects<span style="color: #666666">.</span>get_current()<br />        <span style="color: #007020; font-weight: bold">return</span> {<br />            <span style="color: #4070a0">&#39;current_site&#39;</span>: current_site,<br />        }<br />    <span style="color: #007020; font-weight: bold">except</span> Site<span style="color: #666666">.</span>DoesNotExist:<br />        <span style="color: #60a0b0; font-style: italic"># always return a dict, no matter what!</span><br />        <span style="color: #007020; font-weight: bold">return</span> {<span style="color: #4070a0">&#39;current_site&#39;</span>:<span style="color: #4070a0">&#39;&#39;</span>} <span style="color: #60a0b0; font-style: italic"># an empty string</span></pre></div><br /><br />For this to work, we've got to add the function above to the list of TEMPLATE_CONTEXT_PROCESSORS in our project settings file.  My project directory is called "mysite",  so I created a folder called "context_processors", and in it, I created a file called "current_site.py".  That file contains the function <em>current_site</em> defined above.  <br /><br />To get my new context processor working, I've got to edit mysite/settings.py, which now looks something like the following:<br /><div class="highlight" ><pre>TEMPLATE_CONTEXT_PROCESSORS <span style="color: #666666">=</span> (<br />    <span style="color: #4070a0">&quot;mysite.context_processors.current_site.current_site&quot;</span>,<br />    <span style="color: #4070a0">&quot;django.core.context_processors.auth&quot;</span>, <br />    <span style="color: #4070a0">&quot;django.core.context_processors.debug&quot;</span>,<br />    <span style="color: #4070a0">&quot;django.core.context_processors.i18n&quot;</span>,<br />    <span style="color: #4070a0">&quot;django.core.context_processors.media&quot;</span>, <br />)<br /></pre></div><br /> <br />Voila!  Now, while writing template code, I can always access the <em>current_site</em> variable!<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/4123748873183487963-4532705687996021665?l=bradmontgomery.blogspot.com' alt='' /></div>