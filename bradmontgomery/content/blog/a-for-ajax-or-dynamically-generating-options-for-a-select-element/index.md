---
date: '2009-07-14T11:42:00+00:00'
title: A for AJAX - OR - Dynamically generating options for a select element.
draft: false
tags:
- Javascript
- Prototype
- ajax
- web
slug: a-for-ajax-or-dynamically-generating-options-for-a-select-element
description: I don't do a lot of ...
markup: html
url: /blog/a-for-ajax-or-dynamically-generating-options-for-a-select-element/
aliases:
- /blog/2009/07/14/a-for-ajax-or-dynamically-generating-options-for-a-select-element/

---

I don't do a lot of AJAXy web development, but when I do, I usually make use of <a href="http://prototypejs.org/">Prototype</a>.  I've recently created a form containing a <em>&lt;select&gt;</em> element whose <em>&lt;option&gt;</em>s are dynamically generated via an AJAX request.  The problem however, is that a <em><strong>selected</strong> option</em> was already in the form.  So before the AJAX request, my HTML looked something like this:<br /><div class="highlight" ><pre><span style="color: #062873; font-weight: bold">&lt;select</span> <span style="color: #4070a0">name=&quot;s&quot;</span> <span style="color: #4070a0">id=&quot;s&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val1&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 1<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val2&quot;</span> <span style="color: #4070a0">selected=&quot;selected&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 2<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val3&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 3<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;/select&gt;</span></pre></div><br /><br />We can then use <a href="http://prototypejs.org/api/ajax/request">Ajax.Request</a> method to dynamically add items into this list. (Note here that <em>http://example.com/dynamic/options/</em> would be a server-side script giving us our dynamically generated <em>&lt;option&gt;</em> tags.)  <br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">new</span> <span style="color: #666666">A</span>jax.<span style="color: #666666">R</span>equest(<span style="color: #4070a0">&#39;http://example.com/dynamic/options/&#39;</span><span style="color: #666666">,</span> {<br />    method<span style="color: #666666">:</span> <span style="color: #4070a0">&#39;post&#39;</span><span style="color: #666666">,</span><br />    onSuccess<span style="color: #666666">:</span> <span style="color: #007020; font-weight: bold">function</span>(transport) {<br />        <span style="color: #007020; font-weight: bold">if</span> (transport.responseText)<br />            <span style="color: #666666">E</span>lement.insert($(<span style="color: #4070a0">&#39;s&#39;</span>)<span style="color: #666666">,</span> transport.responseText);<br />    }<br />}); </pre></div><br />Our resulting HTML might look something like the following:<br /><br /><div class="highlight" ><pre><span style="color: #062873; font-weight: bold">&lt;select</span> <span style="color: #4070a0">name=&quot;s&quot;</span> <span style="color: #4070a0">id=&quot;s&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val1&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 1<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val2&quot;</span> <span style="color: #4070a0">selected=&quot;selected&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 2<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val3&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 3<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val4&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 4<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val5&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 5<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;option</span> <span style="color: #4070a0">value=&quot;val6&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Value 6<span style="color: #062873; font-weight: bold">&lt;/option&gt;</span><br /><span style="color: #062873; font-weight: bold">&lt;/select&gt;</span></pre></div><br /><br />One problem that arises, is that once the above <em>&lt;option&gt;s</em> are inserted into the original <em>&lt;select&gt;</em> element, the originally selected option is no longer selected. (In my experiments using Firefox 3.5 on OS X, the last item &mdash; in this case, <em>Value 6</em>&mdash; becomes selected).<br /><br />That's not so bad, though, because a little more code will just set the correct &lt;option&gt; as selected.  The following code looks at all the options until it finds one with the attribute: <em>selected="selected"</em>, and then ... selects it!<br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">var</span> selected_index <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span><br /><span style="color: #007020; font-weight: bold">while</span> (<span style="color: #666666">!</span>$(<span style="color: #4070a0">&#39;s&#39;</span>).down(selected_index).defaultSelected) {<br />    selected_index <span style="color: #666666">+=</span> <span style="color: #40a070">1</span><span style="color: #666666">;</span><br />}               <br />$(<span style="color: #4070a0">&#39;s&#39;</span>).selectedIndex <span style="color: #666666">=</span> selected_index<span style="color: #666666">;</span></pre></div><br /><br /><strong>However...</strong> one must be careful where one puts this code!  You <strong>must</strong> take into account that the Ajax Request is <strong>asynchronous</strong> (that's the <em>A</em> in AJAX)!  <br /><br />Here's what NOT to do:<br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">function</span> append_options() {<br />    <span style="color: #60a0b0; font-style: italic">// Request the dynamically generated options</span><br /><span style="color: #60a0b0; font-style: italic"></span>    <span style="color: #007020; font-weight: bold">new</span> <span style="color: #666666">A</span>jax.<span style="color: #666666">R</span>equest(<span style="color: #4070a0">&#39;http://example.com/dynamic/options/&#39;</span><span style="color: #666666">,</span> {<br />        method<span style="color: #666666">:</span> <span style="color: #4070a0">&#39;post&#39;</span><span style="color: #666666">,</span><br />        onSuccess<span style="color: #666666">:</span> <span style="color: #007020; font-weight: bold">function</span>(transport) {<br />            <span style="color: #007020; font-weight: bold">if</span> (transport.responseText)<br />                <span style="color: #666666">E</span>lement.insert($(<span style="color: #4070a0">&#39;s&#39;</span>)<span style="color: #666666">,</span> transport.responseText);<br />        }   <br />    }); <br />    <span style="color: #60a0b0; font-style: italic">// Make sure the correct on is selected.    var selected_index = 0;</span><br /><span style="color: #60a0b0; font-style: italic"></span>    <span style="color: #007020; font-weight: bold">while</span> (<span style="color: #666666">!</span>$(<span style="color: #4070a0">&#39;s&#39;</span>).down(selected_index).defaultSelected) {<br />        selected_index <span style="color: #666666">+=</span> <span style="color: #40a070">1</span><span style="color: #666666">;</span><br />    }<br />    $(<span style="color: #4070a0">&#39;s&#39;</span>).selectedIndex <span style="color: #666666">=</span> selected_index<span style="color: #666666">;</span><br />}<br /><span style="color: #007020">document</span>.observe(<span style="color: #4070a0">&#39;dom:loaded&#39;</span><span style="color: #666666">,</span> <span style="color: #007020; font-weight: bold">function</span>() {<br />    append_options();<br />});</pre></div><br /><br />The Ajax request is sent, but the portion of the code that selects the option containing selected="selected" may get run <strong>before</strong> there is a response to that Request.  Therefore, the selected option gets set, then the dynamically generated options get inserted.  This is not what we want!<br /><br />The proper way to do this is to use the <em>onComplete</em> callback in Ajax.Request.  This will ensure that the code to select the appropriate option is run <strong>after</strong> the Request is completed. <br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">function</span> append_options() {<br />    <span style="color: #60a0b0; font-style: italic">// Request the dynamically generated options</span><br /><span style="color: #60a0b0; font-style: italic"></span>    <span style="color: #007020; font-weight: bold">new</span> <span style="color: #666666">A</span>jax.<span style="color: #666666">R</span>equest(<span style="color: #4070a0">&#39;http://example.com/dynamic/options/&#39;</span><span style="color: #666666">,</span> {<br />        method<span style="color: #666666">:</span> <span style="color: #4070a0">&#39;post&#39;</span><span style="color: #666666">,</span><br />        onSuccess<span style="color: #666666">:</span> <span style="color: #007020; font-weight: bold">function</span>(transport) {<br />            <span style="color: #007020; font-weight: bold">if</span> (transport.responseText)<br />                <span style="color: #666666">E</span>lement.insert($(<span style="color: #4070a0">&#39;s&#39;</span>)<span style="color: #666666">,</span> transport.responseText);<br />        }<span style="color: #666666">,</span>  <br />        onComplete<span style="color: #666666">:</span> <span style="color: #007020; font-weight: bold">function</span>(transport) {<br />            <span style="color: #60a0b0; font-style: italic">// Make sure the correct on is selected.</span><br /><span style="color: #60a0b0; font-style: italic"></span>            <span style="color: #007020; font-weight: bold">var</span> selected_index <span style="color: #666666">=</span> <span style="color: #40a070">0</span><span style="color: #666666">;</span><br />            <span style="color: #007020; font-weight: bold">while</span> (<span style="color: #666666">!</span>$(<span style="color: #4070a0">&#39;s&#39;</span>).down(selected_index).defaultSelected) {<br />                selected_index <span style="color: #666666">+=</span> <span style="color: #40a070">1</span><span style="color: #666666">;</span><br />            }<br />            $(<span style="color: #4070a0">&#39;s&#39;</span>).selectedIndex <span style="color: #666666">=</span> selected_index<span style="color: #666666">;</span><br />        }<br />    }); <br />}<br /><span style="color: #007020">document</span>.observe(<span style="color: #4070a0">&#39;dom:loaded&#39;</span><span style="color: #666666">,</span> <span style="color: #007020; font-weight: bold">function</span>() {<br />    append_options();<br />});</pre></div><br /><br />This is fairly basic AJAX behavior, but for those of us who don't live, breathe, eat, and sleep AJAX, this is an easy mistake to make.<br /><br />So the moral of this story?  Know your tools!  It's always good to <em>Know what's going on!</em>&trade;<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/4123748873183487963-5043486322654878551?l=bradmontgomery.blogspot.com' alt='' /></div>