---
date: '2010-07-19T16:25:00+00:00'
title: A case for values_list
draft: false
tags:
- django
- python
- web
slug: a-case-for-values_list
description: <p>Here's the Scenar...
markup: html
url: /blog/a-case-for-values_list/
aliases:
- /blog/2010/07/19/a-case-for-values_list/

---

<p>Here's the Scenario:  I have a model (lets call it Contact) with two Foreign Keys, one of which is related to User in Django's contrib.auth app.  I need to build a form that lets me select an existing object, and a new user. <br></p><div class="highlight"><pre><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">ContactType</span>(Model):<br>    name <span style="color: #666666" _mce_style="color: #666666;">=</span> <span style="color: #007020" _mce_style="color: #007020;">CharField</span>(max_length<span style="color: #666666" _mce_style="color: #666666;">=</span><span style="color: #40a070" _mce_style="color: #40a070;">128</span>)<br><br><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">Contact</span>(Model):<br>    user <span style="color: #666666" _mce_style="color: #666666;">=</span> <span style="color: #007020" _mce_style="color: #007020;">ForeignKey</span>(User)<br>    contact_type <span style="color: #666666" _mce_style="color: #666666;">=</span> <span style="color: #007020" _mce_style="color: #007020;">ForeignKey</span>(ContactType)<br>    <span style="color: #60a0b0; font-style: italic" _mce_style="color: #60a0b0; font-style: italic;"># possibly more fields...</span></pre></div><p>I need to select from existing models, so my first thought might be to build a form that uses two <code><a href="http://docs.djangoproject.com/en/1.2/ref/forms/fields/#django.forms.ModelChoiceField" _mce_href="http://docs.djangoproject.com/en/1.2/ref/forms/fields/#django.forms.ModelChoiceField">ModelChoiceField</a></code>'s.  I also want to modify the way that my form displays each choice, so I <em>could</em> extend ModelChoiceField by overriding the <code>label_from_instance</code> method:<br></p><div class="highlight"><pre><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">UserModelChoiceField</span>(ModelChoiceField):<br>    <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">def</span> <span style="color: #06287e" _mce_style="color: #06287e;">label_from_instance</span>(<span style="color: #007020" _mce_style="color: #007020;">self</span>, obj):<br>        <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">return</span> <span style="color: #4070a0" _mce_style="color: #4070a0;">"</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> (</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;">)"</span><span style="color: #666666" _mce_style="color: #666666;">%</span>(obj<span style="color: #666666" _mce_style="color: #666666;">.</span>get_full_name(), obj<span style="color: #666666" _mce_style="color: #666666;">.</span>username)<br><br><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">ContactModelChoiceField</span>(ModelChoiceField):<br>    <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">def</span> <span style="color: #06287e" _mce_style="color: #06287e;">label_from_instance</span>(<span style="color: #007020" _mce_style="color: #007020;">self</span>, obj):<br>        <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">return</span> <span style="color: #4070a0" _mce_style="color: #4070a0;">'</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> (</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;">)'</span> <span style="color: #666666" _mce_style="color: #666666;">%</span> (obj<span style="color: #666666" _mce_style="color: #666666;">.</span>type, obj<span style="color: #666666" _mce_style="color: #666666;">.</span>user<span style="color: #666666" _mce_style="color: #666666;">.</span>get_full_name())<br><br><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">CopyContactForm</span>(forms<span style="color: #666666" _mce_style="color: #666666;">.</span>Form):<br>    contact <span style="color: #666666" _mce_style="color: #666666;">=</span> ContactModelChoiceField(Contact<span style="color: #666666" _mce_style="color: #666666;">.</span>objects<span style="color: #666666" _mce_style="color: #666666;">.</span>all())<br>    new_user <span style="color: #666666" _mce_style="color: #666666;">=</span> UserModelChoiceField(User<span style="color: #666666" _mce_style="color: #666666;">.</span>objects<span style="color: #666666" _mce_style="color: #666666;">.</span>all()<span style="color: #666666" _mce_style="color: #666666;">.</span>order_by(<span style="color: #4070a0" _mce_style="color: #4070a0;">'first_name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'last_name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'username'</span>)) </pre></div><p>This actually provides a solution to my original problem, but it's not very efficient.  Notice that both the <code>UserModelChoiceField</code> and the <code>ContactModelChoiceField</code> call methods on each object with the latter accessing a foreign key.  In an app with 600 Users and 600 Contacts, this form would generate around 1200 queries!<br><br>There's actually a very efficient way to generate the same sort of form using <code><a href="http://docs.djangoproject.com/en/dev/topics/db/optimization/#use-queryset-values-and-values-list" _mce_href="http://docs.djangoproject.com/en/dev/topics/db/optimization/#use-queryset-values-and-values-list">values_list</a></code>, especially, when you realize that the form really just needs to contain something like the following:<br></p><div class="highlight"><pre><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;select&gt;</span><br><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;option</span> <span style="color: #4070a0" _mce_style="color: #4070a0;">value="1"</span><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&gt;</span>John Doe<span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;/option&gt;</span><br><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;option</span> <span style="color: #4070a0" _mce_style="color: #4070a0;">value="2"</span><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&gt;</span>Jane Doe<span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;/option&gt;</span><br><br><span style="color: #062873; font-weight: bold" _mce_style="color: #062873; font-weight: bold;">&lt;/select&gt;</span></pre></div><p>So a more efficient solution to my problem looks something like the code below, which yields two queries.<br></p><div class="highlight"><pre><span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold" _mce_style="color: #0e84b5; font-weight: bold;">CopyContactForm</span>(forms<span style="color: #666666" _mce_style="color: #666666;">.</span>Form):<br>    contact <span style="color: #666666" _mce_style="color: #666666;">=</span> forms<span style="color: #666666" _mce_style="color: #666666;">.</span>ChoiceField(choices<span style="color: #666666" _mce_style="color: #666666;">=</span>[(c[<span style="color: #40a070" _mce_style="color: #40a070;">0</span>], <span style="color: #4070a0" _mce_style="color: #4070a0;">'</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> (</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> </span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;">)'</span><span style="color: #666666" _mce_style="color: #666666;">%</span>(c[<span style="color: #40a070" _mce_style="color: #40a070;">1</span>],c[<span style="color: #40a070" _mce_style="color: #40a070;">2</span>],c[<span style="color: #40a070" _mce_style="color: #40a070;">3</span>])) \<br>        <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">for</span> c <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">in</span> Contact<span style="color: #666666" _mce_style="color: #666666;">.</span>objects<span style="color: #666666" _mce_style="color: #666666;">.</span>values_list(<span style="color: #4070a0" _mce_style="color: #4070a0;">'id'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'type__name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'user__first_name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'user__last_name'</span>)])<br>    new_user <span style="color: #666666" _mce_style="color: #666666;">=</span> forms<span style="color: #666666" _mce_style="color: #666666;">.</span>ChoiceField(choices<span style="color: #666666" _mce_style="color: #666666;">=</span>[(u[<span style="color: #40a070" _mce_style="color: #40a070;">0</span>], <span style="color: #4070a0" _mce_style="color: #4070a0;">'</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> </span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;"> (</span><span style="color: #70a0d0; font-style: italic" _mce_style="color: #70a0d0; font-style: italic;">%s</span><span style="color: #4070a0" _mce_style="color: #4070a0;">)'</span><span style="color: #666666" _mce_style="color: #666666;">%</span>(u[<span style="color: #40a070" _mce_style="color: #40a070;">1</span>],u[<span style="color: #40a070" _mce_style="color: #40a070;">2</span>],u[<span style="color: #40a070" _mce_style="color: #40a070;">3</span>])) \<br>        <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">for</span> u <span style="color: #007020; font-weight: bold" _mce_style="color: #007020; font-weight: bold;">in</span> User<span style="color: #666666" _mce_style="color: #666666;">.</span>objects<span style="color: #666666" _mce_style="color: #666666;">.</span>values_list(<span style="color: #4070a0" _mce_style="color: #4070a0;">'id'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'first_name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'last_name'</span>, <span style="color: #4070a0" _mce_style="color: #4070a0;">'username'</span>)])<br></pre></div><div class="blogger-post-footer"><img width="1" height="1" src="https://blogger.googleusercontent.com/tracker/4123748873183487963-3619337419322141293?l=bradmontgomery.blogspot.com" _mce_src="https://blogger.googleusercontent.com/tracker/4123748873183487963-3619337419322141293?l=bradmontgomery.blogspot.com" alt=""></div>