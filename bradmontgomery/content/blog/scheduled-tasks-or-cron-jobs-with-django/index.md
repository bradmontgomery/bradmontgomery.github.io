---
date: '2009-02-20T10:15:00+00:00'
title: Scheduled Tasks (or cron jobs) with Django
draft: false
tags:
- Python
- cron
- django
- web
slug: scheduled-tasks-or-cron-jobs-with-django
description: This is my take on s...
markup: html
url: /blog/scheduled-tasks-or-cron-jobs-with-django/
aliases:
- /blog/2009/02/20/scheduled-tasks-or-cron-jobs-with-django/

---

This is my take on setting up cron jobs for the apps in a Django project.  It is based on my own convention, and it solves my initial problems where I want to perform some action on all of my Django apps at a periodic interval (currently this is a once-a-day task).<br /><br />In order for this to work, I create a <em>cron.py</em> module for all of my INSTALLED_APPS. This module <strong>must</strong> contain a <em>run</em> method.  Other than that, it can work just like any other python module (using django's internals as necessary).<br /><br />For example, if you had an app called utils (possibly located at mysite/utils/), and if you just wanted to delete all sessions with old expire_dates, your <em>cron.py</em> (which you would put in mysite/utils/cron.py) might look something like this:<br /><div class="highlight" ><pre><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">datetime</span> <span style="color: #007020; font-weight: bold">import</span> datetime<br /><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.contrib.sessions.models</span> <span style="color: #007020; font-weight: bold">import</span> Session<br /><br /><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">delete_old_sessions</span>():<br />    Session<span style="color: #666666">.</span>objects<span style="color: #666666">.</span>filter(expire_date__lt<span style="color: #666666">=</span>datetime<span style="color: #666666">.</span>now())<span style="color: #666666">.</span>delete()<br /><br /><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">run</span>():<br />    delete_old_sessions()<br /></pre></div><br />Now, the meat of this solution checks for the cron.py module in all of the apps in mysite.settings.INSTALLED_APPS, and invokes its run() method.  I've also named this module <em>cron.py</em>, but this gets stored in Django's project directory (e.g. mysite)... the same directory where your <em>settings.py</em> is located.<br /><div class="highlight" ><pre><span style="color: #60a0b0; font-style: italic">#!/usr/bin/env python</span><br /><span style="color: #4070a0; font-style: italic">&quot;&quot;&quot;</span><br /><span style="color: #4070a0; font-style: italic">Project-wide Cron Job... A Command-line Django Script.</span><br /><span style="color: #4070a0; font-style: italic"></span><br /><span style="color: #4070a0; font-style: italic">This script gets scheduled and run by cron (or whatever).</span><br /><span style="color: #4070a0; font-style: italic">It then calls the `run` method of each app&#39;s cron module, </span><br /><span style="color: #4070a0; font-style: italic">if it exists (should be `appname/cron.py`)</span><br /><span style="color: #4070a0; font-style: italic"></span><br /><span style="color: #4070a0; font-style: italic">This script should be invoked after setting the </span><br /><span style="color: #4070a0; font-style: italic">DJANGO_SETTINGS_MODULE environment variable.</span><br /><span style="color: #4070a0; font-style: italic"></span><br /><span style="color: #4070a0; font-style: italic">You chould do this in a BASH script as follows:</span><br /><span style="color: #4070a0; font-style: italic">    export DJANGO_SETTINGS_MODULE=mysite.settings</span><br /><span style="color: #4070a0; font-style: italic">    python /path/to/mysite/cron.py</span><br /><span style="color: #4070a0; font-style: italic">&quot;&quot;&quot;</span><br /><span style="color: #007020; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">django.conf</span> <span style="color: #007020; font-weight: bold">import</span> settings<br /><br /><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">my_import</span>(name):<br />    <span style="color: #4070a0; font-style: italic">&#39;&#39;&#39;</span><br /><span style="color: #4070a0; font-style: italic">    __import__ helper function to import modules inside packages</span><br /><span style="color: #4070a0; font-style: italic">    e.g.:  where name is something like &#39;package.module.mod_i_want&#39;,</span><br /><span style="color: #4070a0; font-style: italic">           would return mod_i_want</span><br /><span style="color: #4070a0; font-style: italic">    </span><br /><span style="color: #4070a0; font-style: italic">    See: http://www.python.org/doc/2.5.2/lib/built-in-funcs.html</span><br /><span style="color: #4070a0; font-style: italic">    &#39;&#39;&#39;</span><br />    mod <span style="color: #666666">=</span> <span style="color: #007020">__import__</span>(name)<br />    components <span style="color: #666666">=</span> name<span style="color: #666666">.</span>split(<span style="color: #4070a0">&#39;.&#39;</span>)<br />    <span style="color: #007020; font-weight: bold">for</span> comp <span style="color: #007020; font-weight: bold">in</span> components[<span style="color: #40a070">1</span>:]:<br />        mod <span style="color: #666666">=</span> <span style="color: #007020">getattr</span>(mod, comp)<br />    <span style="color: #007020; font-weight: bold">return</span> mod<br /><br /><span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">run</span>():<br />    <span style="color: #007020; font-weight: bold">for</span> app <span style="color: #007020; font-weight: bold">in</span> settings<span style="color: #666666">.</span>INSTALLED_APPS:<br />        <span style="color: #007020; font-weight: bold">if</span> <span style="color: #007020; font-weight: bold">not</span> app<span style="color: #666666">.</span>startswith(<span style="color: #4070a0">&#39;django&#39;</span>):<br />            output_info <span style="color: #666666">=</span> <span style="color: #4070a0">&#39;</span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0">.cron&#39;</span><span style="color: #666666">%</span>app<br />            <span style="color: #60a0b0; font-style: italic">## Dynamically import a module called &#39;cron&#39;</span><br />            <span style="color: #60a0b0; font-style: italic">## from each INSTALLED_APP (if it exists)</span><br />            <span style="color: #007020; font-weight: bold">try</span>:<br />                cron_mod <span style="color: #666666">=</span> my_import(app<span style="color: #666666">+</span><span style="color: #4070a0">&#39;.cron&#39;</span>)<br />                output_info <span style="color: #666666">+=</span> <span style="color: #4070a0">&#39;... FOUND&#39;</span><br />                <span style="color: #007020; font-weight: bold">print</span> output_info<br />                <span style="color: #60a0b0; font-style: italic">## 3. Execute the cron&#39;s run method (if it exists)</span><br />                <span style="color: #007020; font-weight: bold">if</span> <span style="color: #007020">hasattr</span>(cron_mod, <span style="color: #4070a0">&#39;run&#39;</span>):<br />                    <span style="color: #60a0b0; font-style: italic">#print &#39;---&gt; calling run()&#39;</span><br />                    cron_mod<span style="color: #666666">.</span>run()<br />            <span style="color: #007020; font-weight: bold">except</span> <span style="color: #007020">ImportError</span>:<br />                <span style="color: #60a0b0; font-style: italic"># ignore packages that don&#39;t have a cron module</span><br />                output_info <span style="color: #666666">+=</span> <span style="color: #4070a0">&#39;... SKIPPED&#39;</span><br />                <span style="color: #007020; font-weight: bold">print</span> output_info<br /><br /><span style="color: #007020; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #4070a0">&quot;__main__&quot;</span>:<br />    run()<br /></pre></div><br /><br />The final piece of this puzzle lies in the BASH script used to invoke the above python module. It makes sure the appropriate environment variables are set and then it invokes the above module.  I also store this in my django project directory (as cron.sh), and I use cron to schedule it to run.<br /><div class="highlight" ><pre><span style="color: #60a0b0; font-style: italic">#!/bin/bash</span><br /><span style="color: #60a0b0; font-style: italic"># This is a Django, Project-specific Cron script.</span><br /><span style="color: #60a0b0; font-style: italic"># Separate Projects would need a copy of this script </span><br /><span style="color: #60a0b0; font-style: italic"># with appropriate Settings export statments.</span><br /><span style="color: #60a0b0; font-style: italic"></span><br /><span style="color: #bb60d5">PYTHONPATH</span><span style="color: #666666">=</span><span style="color: #4070a0">&quot;${PYTHONPATH}:/path/to/django/project/directory&quot;</span><br /><span style="color: #007020">export </span>PYTHONPATH<br /><span style="color: #007020">export </span><span style="color: #bb60d5">DJANGO_SETTINGS_MODULE</span><span style="color: #666666">=</span>mysite.settings<br /><br />python/path/to/django/project/directory/mysite/cron.py<br /></pre></div><br /><br />Using cron, you'd schudule this to run every morning at 6am by editing your crontab and adding the following:<br /><div class="highlight" ><pre><span style="color: #60a0b0; font-style: italic">#m h  dom mon dow   command</span><br /><span style="color: #60a0b0; font-style: italic"></span>  <span style="color: #40a070">0</span>   <span style="color: #40a070">6</span>    *        *      *     /path/to/django/project/directory/cron.sh<br /></pre></div><br /><br />That's it.  This has been working for me, but there is at least one major pitfall:  All of your app's cron tasks get run at the same time. This works well if your apps need to do something once a day (which has been my requirement), but this probably won't work well if you have some apps that need to run tasks at differing times.<br /><br />There are also other solutions to this (none of which I've tried).  There's a snippet at <a href="http://www.djangosnippets.org/snippets/1126/">http://www.djangosnippets.org/snippets/1126/</a> which looks interesting.  Then there's the <a href="http://code.google.com/p/django-cron/">django-cron</a> app which seems to be fairly flexible in how it works, and it doesn't require cron (so this is a plus if you cant set a crontab or if you're on Windows!)<br /><br />Thanks in advance for any feedback... suggestions are always welcome!<div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/4123748873183487963-7714347806734835776?l=bradmontgomery.blogspot.com' alt='' /></div>